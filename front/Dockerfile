FROM node:15.5.1-alpine

ARG WORKDIR
ARG CONTAINER_PORT
ARG API_URL
ARG FIREBASE_API_KEY
ARG FIREBASE_AUTH_DOMAIN
ARG FIREBASE_PROJECT_ID
ARG FIREBASE_STORAGE_BUCKET
ARG FIREBASE_MESSAGING_SENDER_ID
ARG FIREBASE_APP_ID
ARG FIREBASE_MEASUREMENT_ID

ENV RUNTIME_PACKAGES="bash bash-completion" \
    HOME=/${WORKDIR} \
    LANG=C.UTF-8 \
    TZ=Asia/Tokyo \
    HOST=0.0.0.0 \
    API_URL=${API_URL} \
    NPM_CONFIG_PRODUCTION=false \
    FIREBASE_API_KEY=${FIREBASE_API_KEY} \
    FIREBASE_AUTH_DOMAIN=${FIREBASE_AUTH_DOMAIN} \
    FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID} \
    FIREBASE_STORAGE_BUCKET=${FIREBASE_STORAGE_BUCKET} \
    FIREBASE_MESSAGING_SENDER_ID=${FIREBASE_MESSAGING_SENDER_ID} \
    FIREBASE_APP_ID=${FIREBASE_APP_ID} \
    FIREBASE_MEASUREMENT_ID=${FIREBASE_MEASUREMENT_ID} \
		NODE_ENV=production

RUN echo "begin HOME"
RUN echo ${HOME}
RUN echo "end HOME"


RUN echo "begin firebase api key"
RUN echo ${FIREBASE_API_KEY}
RUN echo "end firebase api key"

WORKDIR ${HOME}

RUN apk update && \
		apk upgrade && \
		apk add --no-cache ${RUNTIME_PACKAGES}

COPY package.json ./
COPY yarn.lock ./
RUN yarn install
COPY . .

RUN yarn run build

EXPOSE ${CONTAINER_PORT}
